<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB PDF to Word Translation Service v2</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h2 .step {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8e8ff;
            transform: scale(1.01);
        }
        .upload-area.has-file {
            border-color: #28a745;
            background: #f0fff4;
        }
        .upload-area input[type="file"] {
            display: none;
        }
        .upload-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }
        .upload-text {
            color: #666;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .status {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .status.loading {
            background: #fff8e1;
            color: #f57c00;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f57c00;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }
        .verdict-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .verdict-bar .p { background: #28a745; }
        .verdict-bar .na { background: #ffc107; }
        .verdict-bar .fail { background: #dc3545; }
        .verdict-bar .other { background: #6c757d; }
        .verdict-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
        }
        .verdict-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .verdict-legend .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .files-list {
            margin-top: 16px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .file-item .file-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-item .file-icon {
            font-size: 20px;
        }
        .issues-section {
            margin-top: 20px;
        }
        .issues-section h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .issues-list {
            padding-left: 20px;
            color: #666;
            font-size: 14px;
        }
        .issues-list li {
            margin-bottom: 4px;
        }
        .hidden {
            display: none !important;
        }
        .file-info {
            margin-top: 16px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2e7d32;
        }
        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }
        .progress-bar .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        .api-version {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CB PDF to Word Translation Service</h1>
            <p>IEC 62368-1 CB TRF PDF è‡ªå‹•ç¿»è­¯èˆ‡å›å¡«ç³»çµ±</p>
            <p class="api-version">v2.0 - Pipeline v2</p>
        </header>

        <!-- Upload Card -->
        <div class="card">
            <h2><span class="step">1</span> ä¸Šå‚³ CB PDF</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“„</div>
                <p class="upload-text">é»æ“Šæˆ–æ‹–æ‹½ PDF æª”æ¡ˆåˆ°æ­¤è™•</p>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
            <div class="file-info hidden" id="fileInfo"></div>
        </div>

        <!-- Options Card -->
        <div class="card">
            <h2><span class="step">2</span> è™•ç†é¸é …</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="template">Word æ¨¡æ¿</label>
                    <select id="template">
                        <option value="AST-B">AST-B (45 è¡¨æ ¼å®Œæ•´ç‰ˆ)</option>
                        <option value="Generic-CB">Generic-CB (ç°¡æ˜“ç‰ˆ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mode">è™•ç†æ¨¡å¼</label>
                    <select id="mode">
                        <option value="sync">åŒæ­¥ (ç­‰å¾…å®Œæˆ)</option>
                        <option value="async">éåŒæ­¥ (èƒŒæ™¯åŸ·è¡Œ)</option>
                    </select>
                </div>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="dryRun">
                <label for="dryRun">ä¹¾è·‘æ¨¡å¼ï¼ˆä¸å‘¼å« LLM ç¿»è­¯ï¼‰</label>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="card">
            <button class="btn btn-primary" id="generateBtn" disabled>
                <span id="btnIcon">ğŸš€</span>
                <span id="btnText">é–‹å§‹è™•ç†</span>
            </button>
            <div class="status hidden" id="status">
                <div class="spinner"></div>
                <span id="statusText">è™•ç†ä¸­...</span>
            </div>
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress" id="progress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Result Card -->
        <div class="card hidden" id="resultCard">
            <h2><span class="step">3</span> è™•ç†çµæœ</h2>

            <!-- Metrics Grid -->
            <div class="result-grid">
                <div class="metric-card">
                    <div class="metric-value" id="clauseCount">0</div>
                    <div class="metric-label">æ¢æ¬¾æ•¸é‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="chapterCount">0</div>
                    <div class="metric-label">ç« ç¯€æ•¸é‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="appendedCount">0</div>
                    <div class="metric-label">é™„è¡¨æ•¸é‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="tablesCount">0</div>
                    <div class="metric-label">å·²å¡«å……è¡¨æ ¼</div>
                </div>
            </div>

            <!-- Verdict Distribution -->
            <div class="metric-card" id="verdictSection">
                <div class="metric-label">Verdict åˆ†ä½ˆ</div>
                <div class="verdict-bar" id="verdictBar"></div>
                <div class="verdict-legend">
                    <span><span class="dot" style="background:#28a745"></span> P: <span id="verdictP">0</span></span>
                    <span><span class="dot" style="background:#ffc107"></span> N/A: <span id="verdictNA">0</span></span>
                    <span><span class="dot" style="background:#dc3545"></span> Fail: <span id="verdictFail">0</span></span>
                </div>
            </div>

            <!-- Download Files -->
            <div class="files-list" id="filesList"></div>

            <!-- Issues -->
            <div class="issues-section hidden" id="issuesSection">
                <h3 id="issuesTitle"></h3>
                <ul class="issues-list" id="issuesList"></ul>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const pdfInput = document.getElementById('pdfInput');
        const fileInfo = document.getElementById('fileInfo');
        const templateSelect = document.getElementById('template');
        const modeSelect = document.getElementById('mode');
        const dryRunCheckbox = document.getElementById('dryRun');
        const generateBtn = document.getElementById('generateBtn');
        const btnIcon = document.getElementById('btnIcon');
        const btnText = document.getElementById('btnText');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const resultCard = document.getElementById('resultCard');

        let selectedFile = null;
        let pollingInterval = null;

        // Upload area events
        uploadArea.addEventListener('click', () => pdfInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.pdf')) {
                handleFile(files[0]);
            }
        });

        pdfInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            uploadArea.classList.add('has-file');
            uploadArea.querySelector('.upload-icon').textContent = 'âœ…';
            uploadArea.querySelector('.upload-text').textContent = file.name;
            fileInfo.innerHTML = `
                <strong>æª”æ¡ˆå¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
            `;
            fileInfo.classList.remove('hidden');
            generateBtn.disabled = false;
        }

        // Generate
        generateBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            generateBtn.disabled = true;
            btnIcon.textContent = 'â³';
            btnText.textContent = 'è™•ç†ä¸­...';
            status.className = 'status loading';
            statusText.textContent = 'æ­£åœ¨ä¸Šå‚³ä¸¦è™•ç† PDF...';
            status.classList.remove('hidden');
            progressBar.classList.remove('hidden');
            progress.style.width = '10%';
            resultCard.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', selectedFile);

            const template = templateSelect.value;
            const asyncMode = modeSelect.value === 'async';

            let url = `/api/v2/process?template=${template}&async_mode=${asyncMode}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    if (asyncMode && data.job_id) {
                        // Async mode - start polling
                        pollJobStatus(data.job_id);
                    } else {
                        // Sync mode - show results directly
                        progress.style.width = '100%';
                        showResult(data);
                        showSuccess();
                    }
                } else {
                    showError(data.detail || 'è™•ç†å¤±æ•—');
                }
            } catch (e) {
                showError(e.message);
            }
        });

        async function pollJobStatus(jobId) {
            statusText.textContent = 'ä»»å‹™å·²æäº¤ï¼Œæ­£åœ¨ç­‰å¾…çµæœ...';

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/v2/job/${jobId}`);
                    const job = await response.json();

                    progress.style.width = `${job.progress}%`;
                    statusText.textContent = job.message || `ç‹€æ…‹: ${job.status}`;

                    if (job.status === 'completed') {
                        clearInterval(pollingInterval);
                        showResult(job.result);
                        showSuccess();
                    } else if (job.status === 'failed') {
                        clearInterval(pollingInterval);
                        showError(job.message || 'ä»»å‹™å¤±æ•—');
                    }
                } catch (e) {
                    console.error('Polling error:', e);
                }
            }, 2000);
        }

        function showSuccess() {
            status.className = 'status success';
            statusText.textContent = 'è™•ç†å®Œæˆ!';
            status.querySelector('.spinner')?.remove();
            btnIcon.textContent = 'ğŸš€';
            btnText.textContent = 'é–‹å§‹è™•ç†';
            generateBtn.disabled = false;
        }

        function showError(message) {
            status.className = 'status error';
            statusText.textContent = `éŒ¯èª¤: ${message}`;
            status.querySelector('.spinner')?.remove();
            progressBar.classList.add('hidden');
            btnIcon.textContent = 'ğŸš€';
            btnText.textContent = 'é–‹å§‹è™•ç†';
            generateBtn.disabled = false;
        }

        function showResult(data) {
            // Metrics
            document.getElementById('clauseCount').textContent = data.total_clauses || 0;
            document.getElementById('chapterCount').textContent = data.chapters_count || 0;
            document.getElementById('appendedCount').textContent = data.appended_tables_count || 0;

            // QA Report metrics
            const qa = data.qa_report;
            if (qa && qa.metrics) {
                document.getElementById('tablesCount').textContent = qa.metrics.tables_filled || 0;

                // Verdict distribution
                const p = qa.metrics.verdict_p || 0;
                const na = qa.metrics.verdict_na || 0;
                const fail = qa.metrics.verdict_fail || 0;
                const total = p + na + fail || 1;

                const verdictBar = document.getElementById('verdictBar');
                verdictBar.innerHTML = `
                    <div class="p" style="width:${p/total*100}%"></div>
                    <div class="na" style="width:${na/total*100}%"></div>
                    <div class="fail" style="width:${fail/total*100}%"></div>
                `;

                document.getElementById('verdictP').textContent = p;
                document.getElementById('verdictNA').textContent = na;
                document.getElementById('verdictFail').textContent = fail;
            }

            // Files
            const filesList = document.getElementById('filesList');
            let filesHtml = '';

            if (data.download_url) {
                filesHtml += `
                    <div class="file-item">
                        <div class="file-name">
                            <span class="file-icon">ğŸ“</span>
                            <span>Word è¼¸å‡ºæª”</span>
                        </div>
                        <a href="${data.download_url}" class="btn btn-success" download>ä¸‹è¼‰</a>
                    </div>
                `;
            }

            if (data.output_files) {
                if (data.output_files.extracted_json) {
                    filesHtml += `
                        <div class="file-item">
                            <div class="file-name">
                                <span class="file-icon">ğŸ“‹</span>
                                <span>æ“·å–è³‡æ–™ (JSON)</span>
                            </div>
                            <span style="color:#666;font-size:12px">å·²å„²å­˜è‡³ä¼ºæœå™¨</span>
                        </div>
                    `;
                }
                if (data.output_files.qa_report) {
                    filesHtml += `
                        <div class="file-item">
                            <div class="file-name">
                                <span class="file-icon">ğŸ“Š</span>
                                <span>QA å ±å‘Š (JSON)</span>
                            </div>
                            <span style="color:#666;font-size:12px">å·²å„²å­˜è‡³ä¼ºæœå™¨</span>
                        </div>
                    `;
                }
                if (data.output_files.energy_diagram) {
                    filesHtml += `
                        <div class="file-item">
                            <div class="file-name">
                                <span class="file-icon">ğŸ–¼ï¸</span>
                                <span>èƒ½é‡æºåœ– (PNG)</span>
                            </div>
                            <span style="color:#666;font-size:12px">å·²å„²å­˜è‡³ä¼ºæœå™¨</span>
                        </div>
                    `;
                }
            }

            filesList.innerHTML = filesHtml;

            // Issues
            const issuesSection = document.getElementById('issuesSection');
            const issuesTitle = document.getElementById('issuesTitle');
            const issuesList = document.getElementById('issuesList');

            const allIssues = [...(data.errors || []), ...(data.warnings || [])];
            if (allIssues.length > 0) {
                issuesTitle.textContent = `å•é¡Œ (${allIssues.length})`;
                issuesList.innerHTML = allIssues.slice(0, 10).map(i => `<li>${i}</li>`).join('');
                if (allIssues.length > 10) {
                    issuesList.innerHTML += `<li>...é‚„æœ‰ ${allIssues.length - 10} å€‹é …ç›®</li>`;
                }
                issuesSection.classList.remove('hidden');
            } else {
                issuesSection.classList.add('hidden');
            }

            resultCard.classList.remove('hidden');
        }
    </script>
</body>
</html>
